BackgroundLayer=pc.Layer.extend("background",{},{background:null,init:function(){this._super("background",1);this.background=pc.device.loader.get("background").resource},draw:function(){this.background.draw(pc.device.ctx,0,0)}});PackageSystem=pc.systems.EntitySystem("PackageSystem",{},{packages:null,tileMap:null,init:function(e,t){this.tileMap=t;this.packages=e;this._super(["package"])},push:function(e,t){var n=pc.Point.create(e.x+t.x,e.y+t.y);var r=this.getPackage(n);if(r){var i=r.object().getComponent("spatial");var s=pc.Point.create(n.x+t.x,n.y+t.y);if(this.getPackage(s)){return false}if(this.onTile(s,"wall")){return false}i.pos.x+=t.x;i.pos.y+=t.y;return true}else{return true}},getPackage:function(e){var t=this.packages.first;while(t){var n=t.object().getComponent("spatial");var r=n.getScreenRect();if(r.containsPoint(e)){return t}t=t.next()}return null},onTile:function(e,t){var n=Math.floor(e.x/32);var r=Math.floor(e.y/32);return this.tileMap.tileHasProperty(n,r,t)}});PlayerControlSystem=pc.systems.Input.extend("PlayerControlSystem",{},{playerSpatial:null,packageSystem:null,tileMap:null,init:function(e,t,n){this.tileMap=n;this.playerSpatial=e;this.packageSystem=t;this._super(["input"],60)},onAction:function(e){var t;var n;if(e==="right"){t=pc.Point.create(32,0);n=180}if(e==="left"){t=pc.Point.create(-32,0);n=0}if(e==="up"){t=pc.Point.create(0,-32);n=90}if(e==="down"){t=pc.Point.create(0,32);n=270}this.playerSpatial.dir=n;if(this.leavingMap(t)){return}var r=this.packageSystem.push(this.playerSpatial.getCenterPos(),t);if(r){this.playerSpatial.pos.x+=t.x;this.playerSpatial.pos.y+=t.y}},leavingMap:function(e){var t=Math.floor((e.x+this.playerSpatial.pos.x)/32);var n=Math.floor((e.y+this.playerSpatial.pos.y)/32);return this.tileMap.tileHasProperty(t,n,"wall")}});GameScene=pc.Scene.extend("GameScene",{},{gameLayer:null,entityFactory:null,backgroundLayer:null,finishLayer:null,tileLayer:null,level:1,player:null,playerSpatial:null,displayedWin:false,starSheet:null,currentLevel:null,init:function(){this._super();pc.device.input.bindState(this,"mouseclick","MOUSE_LEFT_BUTTON");this.entityFactory=new EntityFactory;this.loadLevel("level1")},loadLevel:function(e){this.currentLevel=e;var t=this.layers.first;while(t){if(t.obj.reset)t.obj.reset();t=t.next()}this.layers.clear();this.activeLayers.clear();this.displayedWin=false;this.loadFromTMX(pc.device.loader.get(e).resource,this.entityFactory);this.tileLayer=this.get("tiles");this.tileLayer.setZIndex(11);this.gameLayer=this.get("entity");this.gameLayer.setZIndex(20);this.finishLayer=this.get("backgroundEntity");this.finishLayer.setZIndex(21);this.backgroundLayer=new BackgroundLayer;this.addLayer(this.backgroundLayer);this.player=this.gameLayer.entityManager.getTagged("PLAYER").first.object();this.playerSpatial=this.player.getComponent("spatial");this.packages=this.gameLayer.entityManager.getTagged("PACKAGE");this.finishLayer.addSystem(new pc.systems.Render);this.finishLayer.addSystem(new pc.systems.Particles);this.gameLayer.addSystem(new pc.systems.Render);this.gameLayer.addSystem(new pc.systems.Expiration);this.gameLayer.addSystem(new pc.systems.Activation(2e3));this.gameLayer.addSystem(new pc.systems.Layout);var n=new PackageSystem(this.packages,this.tileLayer.tileMap);this.gameLayer.addSystem(new PlayerControlSystem(this.playerSpatial,n,this.tileLayer.tileMap));this.gameLayer.addSystem(n);var r=pc.device.loader.get("stars").resource;this.starSheet=new pc.SpriteSheet({sourceX:20,image:r,frameWidth:20,frameHeight:20,framesWide:3,framesHigh:3})},process:function(){var e=this.checkWinner();var t=this.finishLayer.entityManager.getTagged("RESTART").first.object();var n;if(this.finishLayer.entityManager.getTagged("NEXT_LEVEL")){n=this.finishLayer.entityManager.getTagged("NEXT_LEVEL").first.object()}if(e&&!this.displayedWin){this.displayedWin=true;var r=this.finishLayer.entityManager.getTagged("TREE").first.object();r.addComponent(pc.components.ParticleEmitter.create({spriteSheet:this.starSheet,burst:3,delay:20,thrustMin:5,thrustTime:200,maxVelX:5,maxVelY:5,rangeX:10,rangeY:10,lifeMin:500,alphaMin:1,alphaMax:1,alphaDelay:50,gravityY:0,compositeOperation:"lighter",spinMin:-80,spinMax:80,rotateSprite:true,offsetX:38,offsetY:2}));var i=this.finishLayer.entityManager.getTagged("SANTA").first.object();i.getComponent("sprite").sprite.setAnimation("win")}if(pc.device.input.isInputState(this,"mouseclick")){this.handleMouseClick(t,n,e)}this._super()},handleMouseClick:function(e,t,n){if(e&&e.getComponent("spatial").getScreenRect().containsPoint(pc.device.input.mousePos)){if(!n)this.loadLevel(this.currentLevel);else this.loadLevel("level1")}if(t&&t.getComponent("spatial").getScreenRect().containsPoint(pc.device.input.mousePos)){this.loadLevel("level2")}},checkWinner:function(){var e=this.packages.first;while(e){var t=e.object().getComponent("spatial");var n=t.getCenterPos();if(!this.onTile(n,"finish")){return false}e=e.next()}return true},onTile:function(e,t){var n=Math.floor(e.x/32);var r=Math.floor(e.y/32);return this.tileLayer.tileMap.tileHasProperty(n,r,t)}});EntityFactory=pc.EntityFactory.extend("EntityFactory",{},{packageSheet:null,playerSheet:null,santaSheet:null,treeSheet:null,playagainSheet:null,nextLevelSheet:null,init:function(){this.packageSheet=new pc.SpriteSheet({image:pc.device.loader.get("package").resource,useRotation:false});this.playerSheet=new pc.SpriteSheet({image:pc.device.loader.get("player").resource,useRotation:true});this.santaSheet=new pc.SpriteSheet({image:pc.device.loader.get("santa").resource,frameWidth:67,frameHeight:90});this.santaSheet.addAnimation({name:"win",frameX:1,frameCount:1});this.santaSheet.addAnimation({name:"wait",frameX:0,frameCount:1});this.treeSheet=new pc.SpriteSheet({image:pc.device.loader.get("tree").resource});this.playagainSheet=new pc.SpriteSheet({image:pc.device.loader.get("play_again").resource});this.nextLevelSheet=new pc.SpriteSheet({image:pc.device.loader.get("next_level").resource})},createEntity:function(e,t,n,r,i){var s=null;switch(t){case"player":s=pc.Entity.create(e);s.addTag("PLAYER");s.addComponent(pc.components.Sprite.create({spriteSheet:this.playerSheet}));s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.playerSheet.frameWidth,h:this.playerSheet.frameHeight}));s.addComponent(pc.components.Input.create({actions:[["right",["D","RIGHT"]],["left",["A","LEFT"]],["up",["W","UP"]],["down",["S","DOWN"]]]}));return s;case"package":s=pc.Entity.create(e);s.addTag("PACKAGE");s.addComponent(pc.components.Sprite.create({spriteSheet:this.packageSheet}));s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.packageSheet.frameWidth,h:this.packageSheet.frameHeight}));return s;case"tree":s=pc.Entity.create(e);s.addTag("TREE");s.addComponent(pc.components.Sprite.create({spriteSheet:this.treeSheet}));s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.packageSheet.frameWidth,h:this.packageSheet.frameHeight}));return s;case"restart":s=pc.Entity.create(e);s.addTag("RESTART");s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.playagainSheet.frameWidth,h:this.playagainSheet.frameHeight}));s.addComponent(pc.components.Sprite.create({spriteSheet:this.playagainSheet}));return s;case"nextlevel":s=pc.Entity.create(e);s.addTag("NEXT_LEVEL");s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.playagainSheet.frameWidth,h:this.playagainSheet.frameHeight}));s.addComponent(pc.components.Sprite.create({spriteSheet:this.nextLevelSheet}));return s;case"santa":s=pc.Entity.create(e);s.addTag("SANTA");s.addComponent(pc.components.Sprite.create({spriteSheet:this.santaSheet}));s.addComponent(pc.components.Spatial.create({x:n,y:r,dir:0,w:this.packageSheet.frameWidth,h:this.packageSheet.frameHeight}));return s}throw"Should never get here!"}});TheGame=pc.Game.extend("TheGame",{},{gameScene:null,onReady:function(){this._super();if(pc.device.devMode)pc.device.loader.setDisableCache();pc.device.loader.add(new pc.Image("player","images/figur.png"));pc.device.loader.add(new pc.Image("package","images/paket.png"));pc.device.loader.add(new pc.Image("santa","images/nikol.png"));pc.device.loader.add(new pc.Image("tree","images/tree.png"));pc.device.loader.add(new pc.Image("stars","images/stars.png"));pc.device.loader.add(new pc.Image("basic","images/tiles.png"));pc.device.loader.add(new pc.Image("background","images/background.png"));pc.device.loader.add(new pc.Image("play_again","images/startbutton.png"));pc.device.loader.add(new pc.Image("next_level","images/button_neu.png"));pc.device.loader.add(new pc.DataResource("level1","data/level1.tmx"));pc.device.loader.add(new pc.DataResource("level2","data/level2.tmx"));this.loadingScene=new pc.Scene;this.loadingLayer=new pc.Layer("loading");this.loadingScene.addLayer(this.loadingLayer);pc.device.loader.start(this.onLoading.bind(this),this.onLoaded.bind(this))},onLoading:function(e){var t=pc.device.ctx;t.clearRect(0,0,pc.device.canvasWidth,pc.device.canvasHeight);t.font="normal 50px Verdana";t.fillStyle="#88f";t.fillText("Christmas Sokoban",40,pc.device.canvasHeight/2-50);t.font="normal 18px Verdana";t.fillStyle="#777";t.fillText("Loading: "+e+"%",40,pc.device.canvasHeight/2)},onLoaded:function(){this.gameScene=new GameScene;this.addScene(this.gameScene)}})